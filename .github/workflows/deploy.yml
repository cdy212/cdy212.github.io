name: Node.js CI/CD Deploy

# main 브랜치에 push 될 때만 실행
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. GitHub 저장소에서 코드 체크아웃
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2. Node.js 22 환경 세팅 (빌드용)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22' # 2025년 기준 최신 LTS
          cache: 'npm'

      # 3. 의존성 설치 (CI 명령어 사용)
      - name: Install Dependencies
        run: npm ci
        # 만약 빌드 과정(React build 등)이 필요하면 아래 주석 해제
        # run: npm run build

      # 4. 서버로 파일 전송 (SCP)
      # node_modules와 .git 등 불필요한 파일은 제외하고 소스만 전송
      # target 경로는 STEP 1에서 만든 폴더 경로와 일치해야 함
      - name: Copy files to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          port: ${{ secrets.REMOTE_PORT }}
          source: "."
          target: "/root/my-app" # 서버 폴더 경로 확인 필수
          rm: false 

      # 5. 원격 서버 접속 및 앱 재시작 (SSH)
      - name: Restart Application
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.REMOTE_SSH_KEY }}
          port: ${{ secrets.REMOTE_PORT }}
          script: |
            cd /root/my-app
            
            # 서버에서 프로덕션 의존성 설치
            npm install --production
            
            # PM2로 무중단 재시작 처리 로직
            # 'my-api' 라는 이름으로 실행 중인 프로세스가 있는지 확인
            pm2 describe my-api > /dev/null
            if [ $? -eq 0 ]; then
              # 있으면 재시작 (코드 변경사항 반영)
              echo "Reloding existing application..."
              pm2 reload my-api
            else
              # 없으면 새로 시작 (최초 배포 시)
              # app.js 는 실제 실행 파일명으로 변경하세요
              echo "Starting new application..."
              pm2 start app.js --name "my-api"
            fi
            
            # 서버 재부팅 시 자동 실행 설정 저장
            pm2 save